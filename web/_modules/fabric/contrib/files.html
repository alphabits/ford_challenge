

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>fabric.contrib.files &mdash; Ford challenge v1.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Ford challenge v1.0 documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../../../index.html">Ford challenge v1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" size="18" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for fabric.contrib.files</h1><div class="highlight"><pre>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module providing easy API for working with remote files and folders.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>

<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="o">*</span>


<div class="viewcode-block" id="exists"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.exists">[docs]</a><span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if given path exists on the current remote host.</span>

<span class="sd">    If ``use_sudo`` is True, will use `sudo` instead of `run`.</span>

<span class="sd">    `exists` will, by default, hide all output (including the run line, stdout,</span>
<span class="sd">    stderr and any warning resulting from the file not existing) in order to</span>
<span class="sd">    avoid cluttering output. You may specify ``verbose=True`` to change this</span>
<span class="sd">    behavior.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">use_sudo</span> <span class="ow">and</span> <span class="n">sudo</span> <span class="ow">or</span> <span class="n">run</span>
    <span class="n">cmd</span> <span class="o">=</span> <span class="s">&#39;test -e &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="n">path</span>
    <span class="c"># If verbose, run normally</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="n">func</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">failed</span>
    <span class="c"># Otherwise, be quiet</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;everything&#39;</span><span class="p">),</span> <span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="n">func</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span><span class="o">.</span><span class="n">failed</span>

</div>
<div class="viewcode-block" id="first"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.first">[docs]</a><span class="k">def</span> <span class="nf">first</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given one or more file paths, returns first one found, or None if none</span>
<span class="sd">    exist. May specify ``use_sudo`` which is passed to `exists`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;use_sudo&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">directory</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">directory</span>

</div>
<div class="viewcode-block" id="upload_template"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.upload_template">[docs]</a><span class="k">def</span> <span class="nf">upload_template</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_jinja</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
    <span class="n">template_dir</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render and upload a template text file to a remote host.</span>

<span class="sd">    ``filename`` should be the path to a text file, which may contain `Python</span>
<span class="sd">    string interpolation formatting</span>
<span class="sd">    &lt;http://docs.python.org/release/2.5.4/lib/typesseq-strings.html&gt;`_ and will</span>
<span class="sd">    be rendered with the given context dictionary ``context`` (if given.)</span>

<span class="sd">    Alternately, if ``use_jinja`` is set to True and you have the Jinja2</span>
<span class="sd">    templating library available, Jinja will be used to render the template</span>
<span class="sd">    instead. Templates will be loaded from the invoking user&#39;s current working</span>
<span class="sd">    directory by default, or from ``template_dir`` if given.</span>
<span class="sd">    </span>
<span class="sd">    The resulting rendered file will be uploaded to the remote file path</span>
<span class="sd">    ``destination`` (which should include the desired remote filename.) If the</span>
<span class="sd">    destination file already exists, it will be renamed with a ``.bak``</span>
<span class="sd">    extension.</span>

<span class="sd">    By default, the file will be copied to ``destination`` as the logged-in</span>
<span class="sd">    user; specify ``use_sudo=True`` to use `sudo` instead.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">basename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">temp_destination</span> <span class="o">=</span> <span class="s">&#39;/tmp/&#39;</span> <span class="o">+</span> <span class="n">basename</span>

    <span class="c"># This temporary file should not be automatically deleted on close, as we</span>
    <span class="c"># need it there to upload it (Windows locks the file for reading while</span>
    <span class="c"># open).</span>
    <span class="n">tempfile_fd</span><span class="p">,</span> <span class="n">tempfile_name</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">()</span>
    <span class="n">output</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tempfile_name</span><span class="p">,</span> <span class="s">&quot;w+b&quot;</span><span class="p">)</span>
    <span class="c"># Init</span>
    <span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">if</span> <span class="n">use_jinja</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Environment</span><span class="p">,</span> <span class="n">FileSystemLoader</span>
            <span class="n">jenv</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">template_dir</span> <span class="ow">or</span> <span class="s">&#39;.&#39;</span><span class="p">))</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">jenv</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="o">**</span><span class="n">context</span> <span class="ow">or</span> <span class="p">{})</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="s">&quot;tried to use Jinja2 but was unable to import: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="k">as</span> <span class="n">inputfile</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">inputfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">text</span> <span class="o">%</span> <span class="n">context</span>
    <span class="n">output</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
    <span class="n">output</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c"># Upload the file.</span>
    <span class="n">put</span><span class="p">(</span><span class="n">tempfile_name</span><span class="p">,</span> <span class="n">temp_destination</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">tempfile_fd</span><span class="p">)</span>
    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tempfile_name</span><span class="p">)</span>

    <span class="n">func</span> <span class="o">=</span> <span class="n">use_sudo</span> <span class="ow">and</span> <span class="n">sudo</span> <span class="ow">or</span> <span class="n">run</span>
    <span class="c"># Back up any original file (need to do figure out ultimate destination)</span>
    <span class="n">to_backup</span> <span class="o">=</span> <span class="n">destination</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;everything&#39;</span><span class="p">),</span> <span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="c"># Is destination a directory?</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="s">&#39;test -f </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">to_backup</span><span class="p">)</span><span class="o">.</span><span class="n">failed</span><span class="p">:</span>
            <span class="c"># If so, tack on the filename to get &quot;real&quot; destination</span>
            <span class="n">to_backup</span> <span class="o">=</span> <span class="n">destination</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">basename</span>
    <span class="k">if</span> <span class="n">exists</span><span class="p">(</span><span class="n">to_backup</span><span class="p">):</span>
        <span class="n">func</span><span class="p">(</span><span class="s">&quot;cp </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">.bak&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">to_backup</span><span class="p">,</span> <span class="n">to_backup</span><span class="p">))</span>
    <span class="c"># Actually move uploaded template to destination</span>
    <span class="n">func</span><span class="p">(</span><span class="s">&quot;mv </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">temp_destination</span><span class="p">,</span> <span class="n">destination</span><span class="p">))</span>

</div>
<div class="viewcode-block" id="sed"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.sed">[docs]</a><span class="k">def</span> <span class="nf">sed</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="s">&#39;.bak&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run a search-and-replace on ``filename`` with given regex patterns.</span>

<span class="sd">    Equivalent to ``sed -i&lt;backup&gt; -r -e &quot;/&lt;limit&gt;/ s/&lt;before&gt;/&lt;after&gt;/g</span>
<span class="sd">    &lt;filename&gt;&quot;``.</span>

<span class="sd">    For convenience, ``before`` and ``after`` will automatically escape forward</span>
<span class="sd">    slashes, single quotes and parentheses for you, so you don&#39;t need to</span>
<span class="sd">    specify e.g.  ``http:\/\/foo\.com``, instead just using ``http://foo\.com``</span>
<span class="sd">    is fine.</span>

<span class="sd">    If ``use_sudo`` is True, will use `sudo` instead of `run`.</span>

<span class="sd">    `sed` will pass ``shell=False`` to `run`/`sudo`, in order to avoid problems</span>
<span class="sd">    with many nested levels of quotes and backslashes.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">use_sudo</span> <span class="ow">and</span> <span class="n">sudo</span> <span class="ow">or</span> <span class="n">run</span>
    <span class="c"># Characters to be escaped in both</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="s">&quot;/&#39;&quot;</span><span class="p">:</span>
        <span class="n">before</span> <span class="o">=</span> <span class="n">before</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">r&#39;\</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">char</span><span class="p">)</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">r&#39;\</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">char</span><span class="p">)</span>
    <span class="c"># Characters to be escaped in replacement only (they&#39;re useful in regexen</span>
    <span class="c"># in the &#39;before&#39; part)</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="s">&quot;()&quot;</span><span class="p">:</span>
        <span class="n">after</span> <span class="o">=</span> <span class="n">after</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">r&#39;\</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="n">char</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
        <span class="n">limit</span> <span class="o">=</span> <span class="s">r&#39;/</span><span class="si">%s</span><span class="s">/ &#39;</span> <span class="o">%</span> <span class="n">limit</span>
    <span class="c"># Test the OS because of differences between sed versions</span>
    <span class="k">with</span> <span class="n">hide</span><span class="p">(</span><span class="s">&#39;running&#39;</span><span class="p">,</span> <span class="s">&#39;stdout&#39;</span><span class="p">):</span>
        <span class="n">platform</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="s">&quot;uname&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">platform</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;NetBSD&#39;</span><span class="p">,</span> <span class="s">&#39;OpenBSD&#39;</span><span class="p">):</span>
        <span class="c"># Attempt to protect against failures/collisions</span>
        <span class="n">hasher</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">sha1</span><span class="p">()</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">env</span><span class="o">.</span><span class="n">host_string</span><span class="p">)</span>
        <span class="n">hasher</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="s">&quot;/tmp/</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">hasher</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="c"># Use temp file to work around lack of -i</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s">r&quot;&quot;&quot;cp -p </span><span class="si">%(filename)s</span><span class="s"> </span><span class="si">%(tmp)s</span><span class="s"> \</span>
<span class="s">&amp;&amp; sed -r -e &#39;</span><span class="si">%(limit)s</span><span class="s">s/</span><span class="si">%(before)s</span><span class="s">/</span><span class="si">%(after)s</span><span class="s">/g&#39; </span><span class="si">%(filename)s</span><span class="s"> &gt; </span><span class="si">%(tmp)s</span><span class="s"> \</span>
<span class="s">&amp;&amp; cp -p </span><span class="si">%(filename)s</span><span class="s"> </span><span class="si">%(filename)s%(backup)s</span><span class="s"> \</span>
<span class="s">&amp;&amp; mv </span><span class="si">%(tmp)s</span><span class="s"> </span><span class="si">%(filename)s</span><span class="s">&quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">expr</span> <span class="o">%</span> <span class="nb">locals</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="s">r&quot;sed -i</span><span class="si">%s</span><span class="s"> -r -e &#39;</span><span class="si">%s</span><span class="s">s/</span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="s">/g&#39; </span><span class="si">%s</span><span class="s">&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">expr</span> <span class="o">%</span> <span class="p">(</span><span class="n">backup</span><span class="p">,</span> <span class="n">limit</span><span class="p">,</span> <span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">command</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="uncomment"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.uncomment">[docs]</a><span class="k">def</span> <span class="nf">uncomment</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="s">&#39;.bak&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to uncomment all lines in ``filename`` matching ``regex``.</span>

<span class="sd">    The default comment delimiter is `#` and may be overridden by the ``char``</span>
<span class="sd">    argument.</span>

<span class="sd">    This function uses the `sed` function, and will accept the same</span>
<span class="sd">    ``use_sudo`` and ``backup`` keyword arguments that `sed` does.</span>

<span class="sd">    `uncomment` will remove a single whitespace character following the comment</span>
<span class="sd">    character, if it exists, but will preserve all preceding whitespace.  For</span>
<span class="sd">    example, ``# foo`` would become ``foo`` (the single space is stripped) but</span>
<span class="sd">    ``    # foo`` would become ``    foo`` (the single space is still stripped,</span>
<span class="sd">    but the preceding 4 spaces are not.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">sed</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">before</span><span class="o">=</span><span class="s">r&#39;^([[:space:]]*)</span><span class="si">%s</span><span class="s">[[:space:]]?&#39;</span> <span class="o">%</span> <span class="n">char</span><span class="p">,</span>
        <span class="n">after</span><span class="o">=</span><span class="s">r&#39;\1&#39;</span><span class="p">,</span>
        <span class="n">limit</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
        <span class="n">use_sudo</span><span class="o">=</span><span class="n">use_sudo</span><span class="p">,</span>
        <span class="n">backup</span><span class="o">=</span><span class="n">backup</span>
    <span class="p">)</span>

</div>
<div class="viewcode-block" id="comment"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.comment">[docs]</a><span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">char</span><span class="o">=</span><span class="s">&#39;#&#39;</span><span class="p">,</span> <span class="n">backup</span><span class="o">=</span><span class="s">&#39;.bak&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Attempt to comment out all lines in ``filename`` matching ``regex``.</span>

<span class="sd">    The default commenting character is `#` and may be overridden by the</span>
<span class="sd">    ``char`` argument.</span>

<span class="sd">    This function uses the `sed` function, and will accept the same</span>
<span class="sd">    ``use_sudo`` and ``backup`` keyword arguments that `sed` does.</span>

<span class="sd">    `comment` will prepend the comment character to the beginning of the line,</span>
<span class="sd">    so that lines end up looking like so::</span>

<span class="sd">        this line is uncommented</span>
<span class="sd">        #this line is commented</span>
<span class="sd">        #   this line is indented and commented</span>

<span class="sd">    In other words, comment characters will not &quot;follow&quot; indentation as they</span>
<span class="sd">    sometimes do when inserted by hand. Neither will they have a trailing space</span>
<span class="sd">    unless you specify e.g. ``char=&#39;# &#39;``.</span>

<span class="sd">    .. note:: </span>

<span class="sd">        In order to preserve the line being commented out, this function will</span>
<span class="sd">        wrap your ``regex`` argument in parentheses, so you don&#39;t need to. It</span>
<span class="sd">        will ensure that any preceding/trailing ``^`` or ``$`` characters are</span>
<span class="sd">        correctly moved outside the parentheses. For example, calling</span>
<span class="sd">        ``comment(filename, r&#39;^foo$&#39;)`` will result in a `sed` call with the</span>
<span class="sd">        &quot;before&quot; regex of ``r&#39;^(foo)$&#39;`` (and the &quot;after&quot; regex, naturally, of</span>
<span class="sd">        ``r&#39;#\\1&#39;``.)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">carot</span><span class="p">,</span> <span class="n">dollar</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span>
    <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&#39;^&#39;</span><span class="p">):</span>
        <span class="n">carot</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">regex</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">regex</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;$&#39;</span><span class="p">):</span>
        <span class="n">dollar</span> <span class="o">=</span> <span class="s">&#39;$&#39;</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="n">regex</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">regex</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">)</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">carot</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">dollar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">sed</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span>
        <span class="n">before</span><span class="o">=</span><span class="n">regex</span><span class="p">,</span>
        <span class="n">after</span><span class="o">=</span><span class="s">r&#39;</span><span class="si">%s</span><span class="s">\1&#39;</span> <span class="o">%</span> <span class="n">char</span><span class="p">,</span>
        <span class="n">use_sudo</span><span class="o">=</span><span class="n">use_sudo</span><span class="p">,</span>
        <span class="n">backup</span><span class="o">=</span><span class="n">backup</span>
    <span class="p">)</span>

</div>
<div class="viewcode-block" id="contains"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.contains">[docs]</a><span class="k">def</span> <span class="nf">contains</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">exact</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return True if ``filename`` contains ``text``.</span>

<span class="sd">    By default, this function will consider a partial line match (i.e. where</span>
<span class="sd">    the given text only makes up part of the line it&#39;s on). Specify</span>
<span class="sd">    ``exact=True`` to change this behavior so that only a line containing</span>
<span class="sd">    exactly ``text`` results in a True return value.</span>

<span class="sd">    Double-quotes in either ``text`` or ``filename`` will be automatically</span>
<span class="sd">    backslash-escaped in order to behave correctly during the remote shell</span>
<span class="sd">    invocation.</span>

<span class="sd">    If ``use_sudo`` is True, will use `sudo` instead of `run`.</span>

<span class="sd">    .. versionchanged:: 1.0</span>
<span class="sd">        Swapped the order of the ``filename`` and ``text`` arguments to be</span>
<span class="sd">        consistent with other functions in this module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">use_sudo</span> <span class="ow">and</span> <span class="n">sudo</span> <span class="ow">or</span> <span class="n">run</span>
    <span class="k">if</span> <span class="n">exact</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s">&quot;^</span><span class="si">%s</span><span class="s">$&quot;</span> <span class="o">%</span> <span class="n">text</span>
    <span class="k">with</span> <span class="n">settings</span><span class="p">(</span><span class="n">hide</span><span class="p">(</span><span class="s">&#39;everything&#39;</span><span class="p">),</span> <span class="n">warn_only</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="s">&#39;egrep &quot;</span><span class="si">%s</span><span class="s">&quot; &quot;</span><span class="si">%s</span><span class="s">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;&#39;</span><span class="p">),</span>
            <span class="n">filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;&quot;&#39;</span><span class="p">,</span> <span class="s">r&#39;\&quot;&#39;</span><span class="p">)</span>
        <span class="p">))</span>

</div>
<div class="viewcode-block" id="append"><a class="viewcode-back" href="../../../build/fabric/docs/api/contrib/files.html#fabric.contrib.files.append">[docs]</a><span class="k">def</span> <span class="nf">append</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">partial</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">escape</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append string (or list of strings) ``text`` to ``filename``.</span>

<span class="sd">    When a list is given, each string inside is handled independently (but in</span>
<span class="sd">    the order given.)</span>

<span class="sd">    If ``text`` is already found in ``filename``, the append is not run, and</span>
<span class="sd">    None is returned immediately. Otherwise, the given text is appended to the</span>
<span class="sd">    end of the given ``filename`` via e.g. ``echo &#39;$text&#39; &gt;&gt; $filename``.</span>

<span class="sd">    The test for whether ``text`` already exists defaults to a full line match,</span>
<span class="sd">    e.g. ``^&lt;text&gt;$``, as this seems to be the most sensible approach for the</span>
<span class="sd">    &quot;append lines to a file&quot; use case. You may override this and force partial</span>
<span class="sd">    searching (e.g. ``^&lt;text&gt;``) by specifying ``partial=True``.</span>

<span class="sd">    Because ``text`` is single-quoted, single quotes will be transparently </span>
<span class="sd">    backslash-escaped. This can be disabled with ``escape=False``.</span>

<span class="sd">    If ``use_sudo`` is True, will use `sudo` instead of `run`.</span>

<span class="sd">    .. versionchanged:: 0.9.1</span>
<span class="sd">        Added the ``partial`` keyword argument.</span>

<span class="sd">    .. versionchanged:: 1.0</span>
<span class="sd">        Swapped the order of the ``filename`` and ``text`` arguments to be</span>
<span class="sd">        consistent with other functions in this module.</span>
<span class="sd">    .. versionchanged:: 1.0</span>
<span class="sd">        Changed default value of ``partial`` kwarg to be ``False``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">func</span> <span class="o">=</span> <span class="n">use_sudo</span> <span class="ow">and</span> <span class="n">sudo</span> <span class="ow">or</span> <span class="n">run</span>
    <span class="c"># Normalize non-list input to be a list</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">text</span> <span class="o">=</span> <span class="p">[</span><span class="n">text</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">text</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="s">&#39;^&#39;</span> <span class="o">+</span> <span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="n">partial</span> <span class="k">else</span> <span class="s">&#39;$&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">exists</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="n">line</span>
            <span class="ow">and</span> <span class="n">contains</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">use_sudo</span><span class="o">=</span><span class="n">use_sudo</span><span class="p">)):</span>
            <span class="k">continue</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s">r&#39;</span><span class="se">\&#39;</span><span class="s">&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">escape</span> <span class="k">else</span> <span class="n">line</span>
        <span class="n">func</span><span class="p">(</span><span class="s">&quot;echo &#39;</span><span class="si">%s</span><span class="s">&#39; &gt;&gt; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">filename</span><span class="p">))</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../../../index.html">Ford challenge v1.0 documentation</a> &raquo;</li>
          <li><a href="../../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011, Anders Hørsted.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.0.7.
    </div>
  </body>
</html>